# Auto SRE - LLM Agent Context File
# High-density entry point for AI coding agents (Claude Code, Gemini, etc.)
# Read this FIRST, then follow links to detailed docs as needed.

## IDENTITY
Auto SRE is an AI-powered Site Reliability Engineering agent that automates
incident investigation on Google Cloud Platform using a "Council of Experts"
pattern — specialized sub-agents for traces, logs, metrics, alerts, and root cause.

Version: 0.2.0 | License: Apache-2.0 | Status: Phase 3 active (2277+ backend tests, 129 Flutter tests)

## TECH STACK
- Backend: Python 3.10+ (<3.13), FastAPI, Google ADK 1.23.0, Pydantic 2
- Frontend: Flutter Web (Material 3, Deep Space aesthetic, Riverpod 3.0)

- LLM: Gemini 2.5 Flash/Pro (via `get_model_name("fast"|"deep")`)
- Storage: SQLite (dev) / Cloud SQL (prod), Firestore (configs)
- Telemetry: Cloud Trace, Cloud Logging, Cloud Monitoring (OTel)
- Testing: pytest 8+ (backend), flutter test (frontend), ADK eval (agent quality)
- Package Management: uv (Python), Flutter pub (Dart)
- Task Runner: poethepoet (22+ tasks)
- Linting: Ruff 0.14.14, MyPy (strict), codespell, deptry, detect-secrets

## DIRECTORY MAP
```
sre_agent/                  # Backend source
  agent.py                  # Main orchestrator — 3-stage pipeline (Aggregate > Triage > Deep Dive)
  auth.py                   # Authentication, EUC, token validation, ContextVars
  schema.py                 # Pydantic models (frozen=True, extra="forbid")
  prompt.py                 # Agent system instruction / personality
  model_config.py           # Model configuration (get_model_name("fast"|"deep"), context caching)
  suggestions.py            # Follow-up suggestion generation
  version.py                # Build version and metadata (version, git SHA, timestamp)
  api/
    app.py                  # FastAPI factory (create_app), Pydantic monkeypatch
    middleware.py            # Auth + tracing + CORS middleware stack
    dependencies.py          # DI (session manager, tool context)
    routers/                 # HTTP handlers: agent, sessions, tools, health, system, permissions, preferences, help
    helpers/                 # Tool event streaming (emit_dashboard_event), council graph events
  core/
    runner.py               # Agent execution engine
    runner_adapter.py        # Runner adaptation layer
    router.py               # 3-tier request router (DIRECT/SUB_AGENT/COUNCIL)
    policy_engine.py         # Safety guardrails
    prompt_composer.py       # Dynamic prompt composition
    circuit_breaker.py       # Three-state failure recovery (CLOSED/OPEN/HALF_OPEN)
    model_callbacks.py       # Cost/token tracking, budget enforcement
    context_compactor.py     # Context window management
    summarizer.py            # Response summarization
    approval.py              # Human approval workflow
    tool_callbacks.py        # Tool output truncation and post-processing
    large_payload_handler.py # Automatic sandbox processing for oversized tool outputs
    graph_service.py         # Service dependency graph construction
  council/                  # Parallel Council architecture
    orchestrator.py         # CouncilOrchestrator BaseAgent subclass
    parallel_council.py     # Standard mode: ParallelAgent -> Synthesizer
    debate.py               # Debate mode: panels -> critic loop -> confidence gating
    panels.py               # 5 specialist panel factories (trace, metrics, logs, alerts, data)
    synthesizer.py          # Unified assessment from all panels
    critic.py               # Cross-examination of panel findings
    intent_classifier.py    # Rule-based mode selection + 3-tier routing classification
    adaptive_classifier.py  # LLM-augmented adaptive classifier (Council 2.0)
    mode_router.py          # @adk_tool wrapper for intent classification
    tool_registry.py        # Single source of truth for all domain tool sets (OPT-4)
    schemas.py              # InvestigationMode, RoutingDecision, PanelFinding, CriticReport, CouncilResult, AgentActivity
    prompts.py              # Panel, critic, synthesizer prompts
  sub_agents/               # Specialist agents
    trace.py                # Distributed trace analysis (trace_analyst)
    logs.py                 # Log pattern analysis — Drain3 (log_analyst)
    metrics.py              # Metrics anomaly detection (metrics_analyst, metrics_analyzer)
    alerts.py               # Alert investigation (alert_analyst)
    root_cause.py           # Multi-signal synthesis (root_cause_analyst)
    agent_debugger.py       # Agent execution debugging and self-inspection
  tools/                    # Tool ecosystem (95+ files)
    analysis/               # Pure analysis modules
      trace/                # Trace filtering, comparison, statistics, patterns, critical path
      logs/                 # Pattern extraction, clustering (Drain3)
      metrics/              # Anomaly detection, statistics
      slo/                  # SLO burn rate analysis (multi-window)
      correlation/          # Cross-signal, critical path, dependencies, change correlation
      bigquery/             # BigQuery-based OTel/log analysis
      agent_trace/          # Agent self-analysis trace tools
      remediation/          # Remediation suggestions, postmortem generation
      genui_adapter.py      # GenUI widget generation
      trace_comprehensive.py # Comprehensive trace mega-tool
    clients/                # GCP API clients (singleton factory pattern)
      factory.py            # get_trace_client(), get_logging_client(), etc.
      trace.py, logging.py, monitoring.py, alerts.py, slo.py, gcp_projects.py
      gke.py                # Kubernetes/GKE cluster health tools
      apphub.py             # AppHub client (app-centric resource views)
      app_telemetry.py      # App-aware telemetry (metrics/logs/traces by application)
      asset_inventory.py    # Cloud Asset Inventory (resource configs, change history)
      dependency_graph.py   # Service dependency graph from traces/AppHub
    common/
      decorators.py         # @adk_tool decorator
      cache.py              # TTL data cache (300s)
      telemetry.py          # OTel instrumentation setup
      serialization.py      # JSON serialization helpers
    mcp/                    # Model Context Protocol (BigQuery SQL, heavy queries)
      gcp.py                # MCP toolsets (BigQuery, Logging, Monitoring)
      fallback.py           # MCP -> Direct API fallback
      mock_mcp.py           # Mock MCP for testing
    bigquery/               # BigQuery client, schemas, query builders, CA Data Agent
    sandbox/                # Sandboxed code execution (large data processing)
    discovery/              # GCP resource discovery
    exploration/            # Health check exploration (explore_project_health)
    github/                 # GitHub integration (read, search, PR creation)
    playbooks/              # Runbook execution (GKE, Cloud Run, SQL, Pub/Sub, GCE, BigQuery, self-healing)
    proactive/              # Proactive signal analysis
    synthetic/              # Synthetic data generation for testing
    research.py             # Online research (search_google, fetch_web_page)
    investigation.py        # Investigation state management tools
    reporting.py            # Report synthesis tools
    memory.py               # Memory management tools
    config.py               # Tool configuration registry
    registry.py             # Tool registration and discovery system
    __init__.py             # Tool exports (lazy-loaded via PEP 562)
  services/
    session.py              # Session CRUD (ADKSessionManager)
    storage.py              # Persistence (Firestore/SQLite)
    agent_engine_client.py  # Remote Agent Engine client (dual-mode)
    memory_manager.py       # Memory service
  memory/                   # Memory subsystem (manager, factory, local, callbacks)
  models/
    investigation.py        # InvestigationPhase enum, InvestigationState model
  resources/
    gcp_metrics.py          # GCP metrics catalog by service

autosre/                    # Flutter frontend (Feature-First structure)
  lib/
    features/               # Modern domain-driven features (dashboards, logs, etc.)
    services/               # Core services (Auth, API client, Project, etc.)
    widgets/                # Shared UI components
    models/                 # Shared domain data
    theme/                  # Material 3 deep space theme


tests/                      # Test suite (~218 files)
  conftest.py               # Shared fixtures (log entries, trace spans, mock clients)
  fixtures/                 # Synthetic OTel data generator
  unit/                     # Unit tests — mirrors sre_agent/ structure exactly
  integration/              # Integration tests (auth flow, chat persistence, session lifecycle)
  e2e/                      # End-to-end tests (agent execution, analysis, API flow, CUJs)
  server/                   # FastAPI server tests
  api/                      # API endpoint tests

eval/                       # Agent evaluation framework
  test_evaluate.py          # ADK AgentEvaluator runner
  test_config.json          # Quality criteria (trajectory, rubrics, hallucination, safety)
  basic_capabilities.test.json        # "What can you do?" sanity check
  tool_selection.test.json            # Correct tool routing validation
  metrics_analysis.test.json          # PromQL & anomaly detection eval
  incident_investigation.test.json    # Multi-stage investigation scenario
  error_diagnosis.test.json           # Error diagnosis scenario
  failure_modes.test.json             # Failure mode handling
  kubernetes_debugging.test.json      # K8s/GKE debugging scenario
  multi_signal_correlation.test.json  # Cross-signal correlation eval
  slo_burn_rate.test.json             # SLO burn rate analysis eval

deploy/                     # Deployment scripts
  deploy.py                 # Vertex AI Agent Engine deployment
  deploy_all.py             # Full stack deployment
  deploy_web.py             # Cloud Run frontend deployment
  deploy_gke.py             # Full stack to GKE
  Dockerfile.unified        # Multi-stage Docker build
  k8s/                      # Kubernetes manifests (deployment.yaml, service.yaml)

docs/                       # Documentation (see INDEX below)
server.py                   # FastAPI entry point (loads env, creates app, runs uvicorn)
```

## CRITICAL PATTERNS

### 1. Pydantic Schemas -- Anti-Hallucination
```python
class MySchema(BaseModel):
    model_config = ConfigDict(frozen=True, extra="forbid")
    field: str
```
Note: A Pydantic monkeypatch in `sre_agent/api/app.py` resolves ADK 1.23.0 + Pydantic 2.12+ incompatibility. Do not remove until ADK is updated.

### 2. Tool Implementation
```python
@adk_tool
async def my_tool(arg: str, tool_context: ToolContext | None = None) -> str:
    """Tool description."""
    return json.dumps({"status": "success", "result": {...}})
```
Registration: `__init__.py` exports -> `agent.py` base_tools + TOOL_NAME_MAP -> `config.py` ToolConfig.
For council panels: also add to `council/tool_registry.py`.

### 3. Client Factory (Singleton)
```python
from sre_agent.tools.clients.factory import get_trace_client
client = get_trace_client(tool_context)  # Respects EUC
```

### 4. EUC (End-User Credentials)
Frontend sends `Authorization: Bearer <token>` + `X-GCP-Project-ID` headers.
Middleware extracts into ContextVars. Tools get via `get_credentials_from_tool_context()`.
`STRICT_EUC_ENFORCEMENT=true` blocks ADC fallback.

### 5. Dual-Mode Execution
`SRE_AGENT_ID` not set = local mode (in-process). Set = remote mode (Agent Engine proxy).

### 6. Dashboard Data Channel
Backend emits `{"type": "dashboard", ...}` events via tool_events.py.
Frontend subscribes via `dashboardStream`, decoupled from chat A2UI.
Managed via Riverpod 3.0 `AsyncNotifier` in `lib/features/dashboards/`.
Additional event types: `agent_activity` (per-agent status), `council_graph` (full hierarchy).


### 7. MCP vs Direct API
MCP (mcp/): BigQuery SQL, complex aggregations. Direct (clients/): single fetches, low-latency.
Fallback rule: MCP fails -> Direct API (via `mcp/fallback.py`).

### 8. Council Architecture (3 modes)
Parallel investigation via 5 specialist panels (Trace, Metrics, Logs, Alerts, Data) running in ADK `ParallelAgent`.
Three modes: **Fast** (single panel), **Standard** (5 panels + synthesizer), **Debate** (panels + critic `LoopAgent` + confidence gating).
`CouncilOrchestrator` (`BaseAgent` subclass) manages the lifecycle.
Feature flags: `SRE_AGENT_COUNCIL_ORCHESTRATOR` (enable orchestrator), `SRE_AGENT_SLIM_TOOLS` (reduce root agent to ~20 tools, default `true`).
Schemas: `InvestigationMode`, `RoutingDecision`, `PanelFinding`, `CriticReport`, `CouncilResult`, `CouncilActivityGraph` in `council/schemas.py`.

### 9. 3-Tier Request Router
The `route_request` tool in `core/router.py` classifies every user query into one of three tiers:
- **DIRECT**: Simple data retrieval (e.g. "show me logs") -- calls individual tools directly, no sub-agent.
- **SUB_AGENT**: Focused analysis (e.g. "find anomalies in metrics") -- delegates to specialist sub-agent.
- **COUNCIL**: Complex multi-signal investigation (e.g. "root cause this outage") -- starts council meeting.
Rule-based classification via `council/intent_classifier.py`; maps signal types to suggested tools/agents.

### 10. Adaptive Classifier (Council 2.0)
`council/adaptive_classifier.py` augments the rule-based classifier with LLM-based routing.
Considers session history, alert severity, and remaining token budget.
Budget-aware: auto-downgrades from DEBATE to STANDARD when token budget < 10,000.
Feature flag: `SRE_AGENT_ADAPTIVE_CLASSIFIER=true`.
Falls back to rule-based on any LLM failure.

### 11. Large Payload Handler
`core/large_payload_handler.py` intercepts oversized tool outputs in the `after_tool_callback` chain.
Triggers when result exceeds 50 items or 100,000 chars (configurable via env vars).
Decision flow: known template -> sandbox processing | sandbox available -> generic processing | else -> code-generation prompt.
Tool-to-template mappings for metrics, logs, traces, time series.
Env vars: `SRE_AGENT_LARGE_PAYLOAD_THRESHOLD_ITEMS` (default 50), `SRE_AGENT_LARGE_PAYLOAD_THRESHOLD_CHARS` (default 100000), `SRE_AGENT_LARGE_PAYLOAD_ENABLED` (default true).

### 12. Online Research Tools
`tools/research.py` provides web search and content fetching:
- `search_google`: Google Custom Search JSON API (site restriction, result persistence to memory).
- `fetch_web_page`: Fetch + extract readable text from HTML pages, auto-saves to memory.
Requires: `GOOGLE_CUSTOM_SEARCH_API_KEY`, `GOOGLE_CUSTOM_SEARCH_ENGINE_ID` env vars.

### 13. GitHub Self-Healing Tools
`tools/github/` enables the agent to inspect and modify its own source code:
- `github_read_file`: Read source files from the repo.
- `github_search_code`: Search for code patterns/definitions.
- `github_list_recent_commits`: View recent commit history.
- `github_create_pull_request`: Create draft PRs with code changes (branch must start with `auto-fix/`).
Self-healing playbook in `tools/playbooks/self_healing.py` follows OODA loop: Observe (trace analysis) -> Orient (code research) -> Decide (fix strategy) -> Act (create PR).
All PRs are created as drafts, labeled `agent-generated`, require human review.
Requires: `GITHUB_TOKEN`, `GITHUB_REPO` env vars.

### 14. Session Persistence (CRITICAL)
The `session` object passed to an async generator creates a stale closure.
ALWAYS refresh the session from the DB inside the loop after `await` calls.
Anti-pattern: Using the initial session object after `await session_service.append_event(...)`.

### 15. Circuit Breaker
Three-state breaker (CLOSED/OPEN/HALF_OPEN) in `core/circuit_breaker.py`.
Per-tool configuration via singleton registry. Prevents cascading GCP API failures.

### 16. Model Callbacks
`core/model_callbacks.py` tracks per-agent token usage, estimated USD cost,
and enforces configurable budget (`SRE_AGENT_TOKEN_BUDGET` env var).

### 17. Sandbox Code Execution
`tools/sandbox/` provides isolated code execution for large data processing.
Three modes: Agent Engine (cloud sandbox), Local (`SRE_AGENT_LOCAL_EXECUTION=true`), Disabled (fallback to basic summarization).
Pre-built templates for metrics, logs, traces, time series + custom `execute_custom_analysis_in_sandbox`.
Auto-enabled when `SRE_AGENT_ID` is set. Event visibility for transparency.

### 18. Evaluation Framework
`eval/` directory contains 9 ADK eval scenarios covering:
basic capabilities, tool selection, metrics analysis, incident investigation,
error diagnosis, failure modes, K8s debugging, multi-signal correlation, SLO burn rate.
Quality criteria in `test_config.json`: trajectory accuracy (1.0), rubric-based quality (0.8 threshold),
hallucination detection, safety checks. Judge model: Gemini 2.5 Flash.

## COMMANDS
```bash
uv run poe dev          # Full stack (backend + frontend)
uv run poe web          # Backend server only (FastAPI on port 8001)
uv run poe run          # Terminal agent (adk run)
uv run poe sync         # Install/update all dependencies (uv + flutter)
uv run poe test         # pytest + 80% coverage gate
uv run poe test-fast    # Tests without coverage (fastest)
uv run poe test-all     # Backend + Flutter tests
uv run poe lint         # Ruff format + lint + MyPy + codespell + deptry
uv run poe lint-all     # Backend + Flutter linters
uv run poe eval         # Agent evaluations (trajectory + rubrics)
uv run poe deploy       # Backend to Agent Engine
uv run poe deploy-web   # Frontend to Cloud Run
uv run poe deploy-all   # Full stack deployment
uv run poe deploy-gke   # Full stack to GKE
uv run poe pre-commit   # Run all pre-commit hooks
uv run poe format       # Auto-format code (ruff)
```

## TESTING RULES
- Coverage: 80% minimum gate; 100% target on new tools and core logic
- Async tests: `@pytest.mark.asyncio`
- Mock external APIs: `patch`, `AsyncMock`, `MagicMock` -- never call real GCP in tests
- Test paths mirror source: `sre_agent/tools/clients/trace.py` -> `tests/unit/sre_agent/tools/clients/test_trace.py`
- Test env: `GOOGLE_CLOUD_PROJECT=test-project`, `DISABLE_TELEMETRY=true`, `STRICT_EUC_ENFORCEMENT=false`
- Naming: `test_<function>_<condition>_<expected>` (e.g., `test_fetch_trace_not_found_returns_error`)
- MCP mocking: `USE_MOCK_MCP=true`
- Parallel execution: pytest-xdist with `--dist worksteal`

## ENVIRONMENT VARIABLES (KEY)
| Variable | Purpose | Default |
|----------|---------|---------|
| `GOOGLE_CLOUD_PROJECT` | GCP project ID | required |
| `GOOGLE_CLOUD_LOCATION` | GCP region | us-central1 |
| `SRE_AGENT_ID` | Enables remote mode (Agent Engine) | unset = local |
| `SRE_AGENT_COUNCIL_ORCHESTRATOR` | Enables Council architecture | unset |
| `SRE_AGENT_SLIM_TOOLS` | Reduces root agent tools to ~20 | true |
| `SRE_AGENT_TOKEN_BUDGET` | Max token budget per request | unset |
| `SRE_AGENT_ADAPTIVE_CLASSIFIER` | Enable LLM-augmented intent classifier | false |
| `STRICT_EUC_ENFORCEMENT` | Blocks ADC fallback | false |
| `SRE_AGENT_LOCAL_EXECUTION` | Sandbox local mode | false |
| `SRE_AGENT_LARGE_PAYLOAD_ENABLED` | Enable auto large-payload handling | true |
| `SRE_AGENT_LARGE_PAYLOAD_THRESHOLD_ITEMS` | Item count before sandbox kicks in | 50 |
| `SRE_AGENT_LARGE_PAYLOAD_THRESHOLD_CHARS` | Char count before sandbox kicks in | 100000 |
| `SRE_AGENT_CONTEXT_CACHING` | Enable Vertex AI context caching (OPT-10) | false |
| `SRE_AGENT_ENFORCE_POLICY` | Enable policy engine for tool calls | true |
| `LOG_LEVEL` | Logging level | INFO |
| `USE_MOCK_MCP` | Use mock MCP in tests | false |
| `GOOGLE_CUSTOM_SEARCH_API_KEY` | API key for Google Custom Search (research tools) | unset |
| `GOOGLE_CUSTOM_SEARCH_ENGINE_ID` | Programmable Search Engine ID (research tools) | unset |
| `GITHUB_TOKEN` | GitHub PAT for self-healing tools (needs repo scope) | unset |
| `GITHUB_REPO` | GitHub repo for self-healing (e.g. `user/repo`) | unset |

See `.env.example` for full list and `docs/reference/configuration.md` for details.

## DOCUMENTATION INDEX
```
llm.txt              <- YOU ARE HERE (high-density agent context)
AGENTS.md            <- Universal AI agent standard (patterns, checklists, pitfalls)
CLAUDE.md            <- Claude Code quick rules
README.md            <- Project overview with architecture diagram
docs/
  README.md          <- Full documentation index with navigation
  PROJECT_PLAN.md    <- Living roadmap (update after major changes)
  EVALUATIONS.md     <- Eval standards and rubrics
  OBSERVABILITY.md   <- Tracing and observability guide
  architecture/
    system_overview.md    <- High-level topology and component diagrams
    project_structure.md  <- Detailed directory tree
    backend.md            <- FastAPI, middleware, services
    frontend.md           <- Flutter, state management, GenUI
    telemetry.md          <- OTel instrumentation
    decisions.md          <- Architectural decision records
    help_system.md        <- In-app help system architecture
    AGENTS_AND_TOOLS.md   <- Agent and tool catalog
  agent_ops/
    README.md             <- AgentOps index
    architecture.md       <- Agent Graph reasoning trajectories
    bigquery_setup.md     <- BQ Property Graph setup
    bq_schema.md          <- OTel payload extraction schemas
    dashboard.md          <- AgentOps dashboard capabilities
    dashboards_legacy.md  <- Perses dashboard fallback
    explorer_ui.md        <- Observability Explorer usage
    observability_theory.md <- Theory on graph and log operations
    visualization_setup.md  <- Graph rendering logic
  authentication/
    authentication.md     <- OAuth, session management, EUC
    auth_learnings.md     <- Auth system evolution
  concepts/
    autonomous_reliability.md  <- "Unrolled Codex" event loop pattern
    agent_orchestration.md     <- Council of Experts design
    observability.md           <- Traces, spans, metrics deep dive
    memory.md                  <- State management across sessions
    online_research_and_self_healing.md <- Web search tools + self-healing architecture
    gcp_enhancements.md        <- Future roadmap
  debugging/
    debugging_connectivity.md  <- Network troubleshooting
    debugging_telemetry_and_auth.md  <- Trace/auth diagnosis
    debugging_genui.md         <- Widget rendering issues
  guides/
    getting_started.md         <- Setup and configuration
    development.md             <- "Vibe Coding" handbook
    deployment.md              <- Cloud Run and Agent Engine
    project_selector.md        <- Project selection UX
    dashboard_query_language.md <- MQL, PromQL, SQL capabilities
    rendering_telemetry.md     <- GenUI/A2UI architecture
  testing/
    testing.md                 <- Testing strategy and style guide
    frontend_testing.md        <- Flutter testing guide
    linting.md                 <- Code quality policy
  reference/
    api.md                <- Agent API specification
    configuration.md      <- Environment variable reference
    tools.md              <- Complete tools catalog
    security.md           <- Encryption, key management
```

## CODING RULES (MANDATORY)
1. Read docs & relevant source before coding -- never modify unread files
2. Test first -- create/update tests before implementation
3. Lint always -- `uv run poe lint` must pass clean
4. Explicit types -- mandatory on all functions, no implicit `Any`
5. Imports -- prefer absolute (`from sre_agent.X import Y`); relative OK within same package
6. Schemas -- `extra="forbid"` on all Pydantic models
7. Async -- all external I/O (GCP, DB, LLM) must be async/await
8. Error responses -- `{"status": "error", "error": "message", "non_retryable": bool}`
9. No hardcoded secrets -- use env vars, never commit API keys
10. Update PROJECT_PLAN.md after completing major changes
