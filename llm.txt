# Auto SRE - LLM Agent Context File
# High-density entry point for AI coding agents (Claude Code, Gemini, etc.)
# Read this FIRST, then follow links to detailed docs as needed.

## IDENTITY
Auto SRE is an AI-powered Site Reliability Engineering agent that automates
incident investigation on Google Cloud Platform using a "Council of Experts"
pattern — specialized sub-agents for traces, logs, metrics, alerts, and root cause.

## TECH STACK
- Backend: Python 3.10+, FastAPI, Google ADK 1.23.0
- Frontend: Flutter Web (Material 3, Deep Space aesthetic)
- LLM: Gemini 2.5 Flash (via Vertex AI ADK)
- Storage: SQLite (dev) / Cloud SQL (prod), Firestore (configs)
- Telemetry: Cloud Trace, Cloud Logging, Cloud Monitoring (OTel)
- Testing: pytest 8+ (backend), flutter test (frontend), ADK eval (agent quality)

## DIRECTORY MAP
```
sre_agent/                  # Backend source
  agent.py                  # Main orchestrator — 3-stage pipeline (Aggregate > Triage > Deep Dive)
  auth.py                   # Authentication, EUC, token validation, ContextVars
  schema.py                 # Pydantic models (frozen=True, extra="forbid")
  prompt.py                 # Agent system instruction / personality
  suggestions.py            # Follow-up suggestion generation
  api/
    app.py                  # FastAPI factory (create_app), Pydantic patches
    middleware.py            # Auth + tracing + CORS middleware stack
    dependencies.py          # DI (session manager, tool context)
    routers/                 # HTTP handlers: agent, sessions, tools, health, system, permissions, preferences
    helpers/                 # Tool event streaming (emit_dashboard_event)
  core/
    runner.py               # Agent execution engine
    runner_adapter.py        # Runner adaptation layer
    policy_engine.py         # Safety guardrails
    prompt_composer.py       # Dynamic prompt composition
    graph_service.py         # Graph-based reasoning
    context_compactor.py     # Context window management
    summarizer.py            # Response summarization
    approval.py              # Human approval workflow
  sub_agents/               # Specialist agents
    trace.py                # Distributed trace analysis
    logs.py                 # Log pattern analysis (Drain3)
    metrics.py              # Metrics anomaly detection
    alerts.py               # Alert investigation
    root_cause.py           # Multi-signal synthesis
  tools/
    analysis/               # Pure analysis modules
      trace/                # Trace filtering, comparison, statistics, selection
      logs/                 # Pattern extraction, clustering
      metrics/              # Anomaly detection, statistics
      correlation/          # Cross-signal correlation, critical path, dependencies
      bigquery/             # BigQuery-based analysis (logs, OTel, advanced)
      remediation/          # Remediation suggestion engine
      genui_adapter.py      # GenUI widget generation
    clients/                # GCP API clients (singleton factory pattern)
      factory.py            # get_trace_client(), get_logging_client(), etc.
      trace.py, logging.py, monitoring.py, alerts.py, gke.py, slo.py, gcp_projects.py
    common/
      decorators.py         # @adk_tool decorator
      cache.py              # TTL data cache (300s)
      telemetry.py          # OTel instrumentation setup
      serialization.py      # JSON serialization helpers
    mcp/                    # Model Context Protocol (BigQuery SQL, heavy queries)
    bigquery/               # BigQuery client, schemas, query builders
    discovery/              # GCP resource discovery
    proactive/              # Proactive signal analysis
    config.py               # Tool configuration registry
  services/
    session.py              # Session CRUD (ADKSessionManager)
    storage.py              # Persistence (Firestore/SQLite)
    agent_engine_client.py  # Remote Agent Engine client (dual-mode)
    memory_manager.py       # Memory service
  memory/                   # Memory subsystem (manager, factory, local)
  models/
    investigation.py        # InvestigationPhase enum, InvestigationState model
  resources/
    gcp_metrics.py          # GCP metrics catalog by service

autosre/                    # Flutter frontend
  lib/
    pages/                  # Login, conversation (97KB main UI), tool config
    services/               # Auth, API client, session, dashboard state, connectivity
    widgets/                # Dashboard panels, trace waterfall, charts, remediation plan
      canvas/               # Agent activity, AI reasoning, alerts, incident timeline, metrics, topology
      dashboard/            # Live panels (alerts, logs, metrics, remediation, traces)
    models/                 # ADK schema definitions
    theme/                  # Material 3 deep space theme

tests/                      # Test suite (~138 files)
  conftest.py               # Shared fixtures (log entries, trace spans, mock clients)
  fixtures/                 # Synthetic OTel data generator (27KB)
  unit/                     # Unit tests — mirrors sre_agent/ structure exactly
  integration/              # Integration tests (auth flow, chat persistence, session lifecycle)
  e2e/                      # End-to-end tests (agent execution, analysis, API flow, CUJs)
  server/                   # FastAPI server tests

eval/                       # Agent evaluation framework
  test_evaluate.py          # ADK AgentEvaluator runner (3 eval suites)
  test_config.json          # Quality criteria (trajectory, rubrics, hallucination, safety)
  basic_capabilities.test.json    # "What can you do?" sanity check
  tool_selection.test.json        # Correct tool routing validation (3 cases)
  metrics_analysis.test.json      # PromQL & anomaly detection eval
  incident_investigation.test.json # Multi-stage investigation scenario

deploy/                     # Deployment scripts
  deploy.py                 # Vertex AI Agent Engine deployment
  deploy_all.py             # Full stack deployment
  deploy_web.py             # Cloud Run frontend deployment

docs/                       # Documentation (see INDEX below)
server.py                   # FastAPI entry point (loads env, creates app, runs uvicorn)
```

## CRITICAL PATTERNS

### 1. Pydantic Schemas — Anti-Hallucination
```python
class MySchema(BaseModel):
    model_config = ConfigDict(frozen=True, extra="forbid")
    field: str
```

### 2. Tool Implementation
```python
@adk_tool
async def my_tool(arg: str, tool_context: ToolContext | None = None) -> str:
    """Tool description."""
    return json.dumps({"status": "success", "result": {...}})
```
Registration: __init__.py exports, agent.py base_tools + TOOL_NAME_MAP, config.py ToolConfig.

### 3. Client Factory (Singleton)
```python
from sre_agent.tools.clients.factory import get_trace_client
client = get_trace_client(tool_context)  # Respects EUC
```

### 4. EUC (End-User Credentials)
Frontend sends `Authorization: Bearer <token>` + `X-GCP-Project-ID` headers.
Middleware extracts into ContextVars. Tools get via `get_credentials_from_tool_context()`.
`STRICT_EUC_ENFORCEMENT=true` blocks ADC fallback.

### 5. Dual-Mode Execution
`SRE_AGENT_ID` not set = local mode (in-process). Set = remote mode (Agent Engine proxy).

### 6. Dashboard Data Channel
Backend emits `{"type": "dashboard", ...}` events via tool_events.py.
Frontend subscribes via `dashboardStream`, decoupled from chat A2UI.

### 7. MCP vs Direct API
MCP (mcp/): BigQuery SQL, complex aggregations. Direct (clients/): single fetches, low-latency.
Fallback rule: MCP fails -> Direct API.

## COMMANDS
```bash
uv run poe dev          # Full stack (backend + frontend)
uv run poe web          # Backend server only
uv run poe run          # Terminal agent (adk run)
uv run poe test         # pytest + 80% coverage gate
uv run poe test-all     # Backend + Flutter tests
uv run poe lint         # Ruff format + lint + MyPy + codespell + deptry
uv run poe lint-all     # Backend + Flutter linters
uv run poe eval         # Agent evaluations (trajectory + rubrics)
uv run poe deploy       # Backend to Agent Engine
uv run poe deploy-web   # Frontend to Cloud Run
uv run poe deploy-all   # Full stack deployment
uv run poe sync         # Install/update all dependencies
```

## TESTING RULES
- Coverage gate: 80% minimum (100% target on new code)
- Async tests: `@pytest.mark.asyncio`
- Mock external APIs: `patch`, `AsyncMock`, `MagicMock`
- Test paths mirror source: `sre_agent/tools/clients/trace.py` -> `tests/unit/sre_agent/tools/clients/test_trace.py`
- Test env: `GOOGLE_CLOUD_PROJECT=test-project`, `DISABLE_TELEMETRY=true`, `STRICT_EUC_ENFORCEMENT=false`
- Naming: `test_<function>_<condition>_<expected>` (e.g., `test_fetch_trace_not_found_returns_error`)

## DOCUMENTATION INDEX
```
llm.txt              <- YOU ARE HERE (high-density agent context)
AGENTS.md            <- Universal AI agent standard (patterns, checklists, pitfalls)
CLAUDE.md            <- Claude Code quick rules
README.md            <- Project overview with architecture diagram
docs/
  README.md          <- Full documentation index with navigation
  PROJECT_PLAN.md    <- Living roadmap (update after major changes)
  EVALUATIONS.md     <- Eval standards and rubrics
  OBSERVABILITY.md   <- Tracing and observability guide
  architecture/
    system_overview.md    <- High-level topology and component diagrams
    project_structure.md  <- Detailed directory tree
    backend.md            <- FastAPI, middleware, services
    frontend.md           <- Flutter, state management, GenUI
    authentication.md     <- OAuth, session management, EUC
    telemetry.md          <- OTel instrumentation
    decisions.md          <- Architectural decision records
  concepts/
    autonomous_reliability.md  <- "Unrolled Codex" event loop pattern
    agent_orchestration.md     <- Council of Experts design
    observability.md           <- Traces, spans, metrics deep dive
    memory.md                  <- State management across sessions
    auth_learnings.md          <- Auth system evolution
    gcp_enhancements.md        <- Future roadmap
  guides/
    getting_started.md         <- Setup and configuration
    development.md             <- "Vibe Coding" handbook
    testing.md                 <- Testing strategy and style guide
    linting.md                 <- Code quality policy
    deployment.md              <- Cloud Run and Agent Engine
    evaluation.md              <- Agent benchmarking
    debugging_connectivity.md  <- Network troubleshooting
    debugging_telemetry_and_auth.md  <- Trace/auth diagnosis
    debugging_genui.md         <- Widget rendering issues
    rendering_telemetry.md     <- GenUI/A2UI architecture
  reference/
    api.md                <- Agent API specification
    configuration.md      <- Environment variable reference
    tools.md              <- Complete tools catalog
    security.md           <- Encryption, key management
```

## CODING RULES (MANDATORY)
1. Read docs & relevant source before coding — never modify unread files
2. Test first — create/update tests before implementation
3. Lint always — `uv run poe lint` must pass clean
4. Explicit types — mandatory on all functions, no implicit `Any`
5. Absolute imports — `from sre_agent.X import Y`
6. Schemas — `extra="forbid"` on all Pydantic models
7. Async — all external I/O (GCP, DB, LLM) must be async/await
8. Error responses — `{"status": "error", "error": "message", "non_retryable": bool}`
9. No hardcoded secrets — use env vars, never commit API keys
10. Update PROJECT_PLAN.md after completing major changes
