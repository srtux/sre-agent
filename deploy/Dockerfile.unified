FROM node:20-slim AS builder

WORKDIR /app

# Copy web package files
COPY web/package*.json ./
COPY web/ ./

# Install dependencies and build
RUN npm ci
RUN npm run build

# --- Production Stage ---
FROM python:3.11-slim

# Install Node.js runtime for Next.js
RUN apt-get update && apt-get install -y \
    curl \
    && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 1. Setup Python Backend
COPY pyproject.toml .
COPY sre_agent/ ./sre_agent/
COPY server.py .
COPY README.md .

# Install Python dependencies
RUN pip install --no-cache-dir . uvicorn fastapi google-adk google-cloud-aiplatform

# 2. Setup Next.js Frontend (from builder)
# We copy the standalone build
COPY --from=builder /app/.next/standalone ./web/
COPY --from=builder /app/.next/static ./web/.next/static
COPY --from=builder /app/public ./web/public

# 3. Startup Script
COPY scripts/start_unified.sh .
RUN chmod +x start_unified.sh

# Environment variables
ENV PORT=8080
ENV HOSTNAME="0.0.0.0"
ENV SRE_AGENT_URL="http://127.0.0.1:8000"

CMD ["./start_unified.sh"]
