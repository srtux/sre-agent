# Agent Graph BigQuery Schema Documentation

This document provides a comprehensive overview of how telemetry and observability data generated by the SRE Agent and captured via OpenTelemetry are stored and structured in BigQuery.

## 1. Raw Trace Data (`summitt-gcp.traces._AllSpans`)

This view stores the raw OpenTelemetry span data, representing all executions within the system. This includes Agent executions, Tool invocations, LLM completions, and platform routing logic.

### 1.1 Key Filter for Agent Traces
To look exclusively at traces coming from the Agent Engine infrastructure, you must filter based on the `resource` attributes map:
- `JSON_VALUE(resource.attributes["cloud.platform"]) = "gcp.agent_engine"`

### 1.2 Schema Core Structure
- **trace_id** (`STRING`): The unique identifier grouping a set of operations.
- **span_id** (`STRING`): The unique identifier for a specific operation.
- **name** (`STRING`): Identifier name of the span (e.g., `invoke_agent sre_agent`, `execute_tool route_request`, `call_llm`).
- **start_time** (`TIMESTAMP`): Time span was entered.
- **end_time** (`TIMESTAMP`): Time span completed.
- **attributes** (`JSON`): Context-specific span attributes, containing tool configurations, LLM metadata (`gen_ai.request.model`), trace session IDs (`session_id`), input/output text sizes, and error stacks.
- **resource.attributes** (`JSON`): Environment variables showing cloud project, cluster, or execution platform constraints (e.g., `telemetry.sdk.language`).

### 1.3 View Sample
```json
{
  "trace_id": "e4253d36b9b02cfeb0ede9b73b160d6e",
  "span_id": "ad36fe3d026b7cb8",
  "name": "invoke_agent sre_agent",
  "start_time": "2026-02-19 04:54:18 UTC",
  "end_time": "2026-02-19 04:54:21 UTC",
  "resource_attributes": {
    "cloud.account.id": "summitt-gcp",
    "cloud.platform": "gcp.agent_engine",
    "cloud.provider": "gcp",
    "cloud.region": "us-central1",
    "service.name": "sre-agent",
    "telemetry.sdk.language": "python"
  },
  "span_attributes": {
    "gen_ai.agent.description": "SRE Agent - Google Cloud...",
    "gen_ai.agent.name": "sre_agent",
    "gen_ai.conversation.id": "6026895059767525376",
    "gen_ai.operation.name": "invoke_agent"
  }
}
```

---

## 2. Agent Graph Dataset (`summitt-gcp.agent_graph`)

This dataset provides deeply structured and pre-aggregated views that power the AgentOps dashboards. It converts arbitrary span tags into first-class relational schema fields to make metric calculations simpler.

### 2.1 `agent_spans_raw`
The cleaned, foundational view that extracts properties like duration, status, and tokens directly from the unstructured JSON attribute blocks.

**Schema Output**:
- `span_id`, `parent_id`, `trace_id` (`STRING`)
- `start_time` (`TIMESTAMP`)
- `session_id`, `project_id` (`STRING`)
- `duration_ms` (`FLOAT`)
- `status_code`, `status_desc` (`STRING`)
- `input_tokens`, `output_tokens` (`INTEGER`)
- `node_type`, `node_label`, `logical_node_id`, `service_name` (`STRING`)

**Sample Row**:
```json
{
  "duration_ms": 1792.68,
  "input_tokens": 11810,
  "logical_node_id": "Glue::call_llm",
  "node_label": "call_llm",
  "node_type": "Glue",
  "output_tokens": 5,
  "parent_id": "4597a6efee8fdf2f",
  "service_name": "sre-agent",
  "span_id": "d779817053dca8b4",
  "trace_id": "19d3433bf089565502075f334d2dccc7"
}
```

### 2.2 `agent_nodes_view`
Derived from `agent_spans_raw`, capturing more verbose entity descriptions suitable for visual nodes.

**Extended Fields**:
- `agent_description` (`STRING`)
- `tool_description` (`STRING`)
- `error_type` (`STRING`)


### 2.3 `agent_topology_nodes`
Summarizes executions to provide standard analytical aggregates across each `logical_node_id` (used as the primary key).

**Schema Entities**:
- *Identifiers*: `trace_id`, `session_id`, `logical_node_id`, `service_name`
- *Metadata*: `node_type`, `node_label`
- *Counters*: `execution_count`, `error_count`, `total_input_tokens`, `total_output_tokens`
- *Metrics*: `total_duration_ms`

**Sample Row**:
```json
{
  "logical_node_id": "User::session",
  "node_label": "session",
  "node_type": "User",
  "execution_count": 1,
  "error_count": 0,
  "total_duration_ms": 114813.10
}
```

### 2.4 `agent_topology_edges`
Describes transitions from a source logic execution context to its child (or subsequent logic step). Used extensively for the Graph UI to visualize flows between Agents, Tools, and LLMs.

**Schema Entities**:
- `source_node_id` (`STRING`)
- `destination_node_id` (`STRING`)
- `edge_weight` (`INTEGER`)
- `total_duration_ms` (`FLOAT`)
- `total_tokens` (`INTEGER`)
- `input_tokens`, `output_tokens` (`INTEGER`)
- `error_count` (`INTEGER`)

**Sample Row**:
```json
{
  "source_node_id": "Agent::metrics_panel",
  "destination_node_id": "Tool::query_promql",
  "edge_weight": 5,
  "total_duration_ms": 2168.66,
  "error_count": 0
}
```

### 2.5 `agent_trajectories`
Presents broader execution flows tracing multi-step patterns by tracking source interactions that directly invoke a target. Focuses heavily on the cost in tokens and ms.

**Key Fields**:
- `source_node`, `source_type`, `source_label`
- `target_node`, `target_type`, `target_label`
- `trace_count`, `total_source_duration_ms`, `total_target_duration_ms`
- `total_source_tokens`, `total_target_tokens`
- `error_transition_count`


### 2.6 Rollup Metrics Views
Used by dashboards for historical analysis and service level evaluations:
- `tool_registry`: Tracks `avg_duration_ms`, `p95_duration_ms`, `error_rate`, and `execution_count` grouped by `time_bucket` and `tool_id`.
- `agent_registry`: Tracks `p50_duration_ms`, `p95_duration_ms`, `total_sessions`, `total_turns`, and `error_count` per `agent_name` over time buckets.
- `agent_graph_hourly`: Massive denormalized view linking topology relationships over time buckets (`call_count`, `edge_tokens`, `total_cost`, `node_has_error`, `node_max_p95_duration_ms`) to support sankey diagram queries.

---

## 3. Performance Optimization Recommendations

To maximize performance for the Agent Graph dashboard and reduce query latency, we highly recommend leveraging BigQuery's advanced features.

### 3.1 BigQuery Advanced Runtime & Short Query Optimizations
The Agent Graph queries are designed to be fast and lightweight. To ensure you receive the lowest latency possible, always execute queries using the synchronous query method (e.g., `client.query_and_wait()` in Python or the REST `jobs.query` API) instead of the asynchronous Jobs API (`jobs.insert`).

By using the synchronous API, BigQuery automatically routes the request through the **Advanced Runtime**, bypassing job creation overhead and utilizing **Short Query Optimizations**. This delivers significantly faster responses for the topological graph and telemetry lookups.

### 3.2 BI Engine Preferred Tables
Due to the frequency of topological lookups and aggregate calculations required by the Agent Graph UI, you should configure BI Engine reservations and add the following views/tables to your **BI Engine Preferred Tables** list:
- `summitt-gcp.agent_graph.agent_spans_raw`
- `summitt-gcp.agent_graph.agent_graph_hourly`

Enabling BI Engine for these tables caches them in fast memory, producing sub-second latency for repeat topological and timeseries lookups.
